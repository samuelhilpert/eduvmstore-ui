{% extends 'base.html' %}
{% load static %}
{% block title %}Instructions{% endblock %}

{% block page_header %}
    <div style="display: flex; align-items: center; justify-content: space-between;  border-bottom: 1px solid #e0e0e0;">
        <div style="margin-right: 15px;">
            <h1 class="page-title mb-0">
                Example
            </h1>
        </div>
        <div>
            <img src="{% static 'images/EduVMStoreLogo.png' %}" alt="Logo" class="logo-img"
                 style="height: 95px;">
        </div>
    </div>
{% endblock page_header %}

{% block main %}

    <style>

        .accordion {
            background: linear-gradient(135deg, #333, #777);
            color: white;
            cursor: pointer;
            padding: 15px;
            width: 100%;
            text-align: left;
            border: none;
            outline: none;
            transition: background-color 0.3s ease;
            font-size: 16px;
            border-radius: 5px;
            margin-top: 5px;
        }

        .accordion:hover {
            background-color: #555;
        }

        .panel {
            display: none;
            padding: 15px;
            background-color: #fff;
            border-radius: 5px;
            margin-top: 5px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .contact-container {
            width: 100%;
            margin: auto;
            padding: 20px;
            background: #fff;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

    </style>


    <hr>
    <h2 style="text-align: center; color: #333;">Examples</h2>
    <p style="text-align: center; color: #666; font-size: 16px;">Here are some examples of use cases and how
        to use the EduVMStore.</p>
    <hr>
    <button class="accordion">Use Case <strong>GitLab Server</strong>: How to set up a GitLab server for a
        software engineering course?
    </button>
    <div class="panel">
        <p><strong>Use Case for Lecturers:</strong></p>
        <p>This example demonstrates how lecturers can set up a GitLab server for a software engineering
            course using the EduVMStore. The setup enables students to collaborate on projects and manage
            their code repositories effectively, providing a practical learning environment.</p>
        <p><strong>Overview:</strong> Lecturers will create an AppTemplate that includes a cloud-init script
            to configure the GitLab server and add students with their access credentials. This ensures a
            streamlined process for deploying and managing the server.</p>
        <p><strong>Steps:</strong> By following this example, lecturers will learn how to:</p>
        <ul>
            <li>Create an AppTemplate tailored for the course requirements.</li>
            <li>Write a configuration script to automate the setup of the GitLab server.</li>
            <li>Launch and manage an instance of the GitLab server for their students.</li>
        </ul>
        <br/>
        <p><strong>Note:</strong> This example assumes a basic understanding of the EduVMStore platform. If
            you are new to EduVMStore, refer to the
            <a href="{% url 'horizon:eduvmstore_dashboard:instructions:index' %}"
               target="_blank">instruction</a> section for a comprehensive guide on
            getting started.</p>
        <p>For detailed information about GitLab and its features, visit the official
            <a href="https://about.gitlab.com/" target="_blank">GitLab documentation</a>.</p>

        <h3>1. Create an AppTemplate</h3>
        <p>To create an AppTemplate for the GitLab server, follow these steps:</p>
        <ol>
            <li>Navigate to the AppTemplates section in the EduVMStore Dashboard.</li>
            <li>Click on the "Create New AppTemplate" button.</li>
            <li><strong>General Configuration:</strong>
                <ul>
                    <li>Step 1: Select the base image for the AppTemplate. For this example, choose a
                        suitable Linux distribution (e.g., Ubuntu or CentOS) that supports GitLab.
                    </li>
                    <li>Step 2: Fill in the general information for the AppTemplate, including the
                        "App-Template Name", "Short Description", and any other relevant details.
                    </li>
                    <li>Step 3: Select if the AppTemplate should be available for everyone or
                        only for the creator.
                    </li>
                </ul>
            </li>
            <li><strong>Configure minimum resources requirements:</strong>
                <ul>
                    <li>Step 1: Enter the appropriate fixed minimum resources for the AppTemplate, such as
                        RAM, disk space, and CPU cores.
                        Ensure that the resources meet the requirements for running GitLab.
                    </li>
                    <li>Step 2: Optionally enter a volume size.</li>
                    <li>Step 3: Choose the minimum resources per User for the AppTemplate
                        (RAM, disk space, CPU cores).
                    </li>
                </ul>
            </li>
            <li><strong>Write Configuration Script:</strong>
                <ul>
                    <li>Step 1: Optionally select the checkbox to automatically generate the SSH setup for
                        users.
                        This will create a script that sets up SSH access for the students.
                    </li>
                    <li>Step 2: Enter instantiation and account attributes to be used in the configuration
                        script. For example <code>username:password:firstname:lastname:email</code>
                        as account attributes.
                    </li>
                    <li>Step 3: Upload a configuration script (cloud-init script) or write it directly after
                        clicking the "Write Script" button. Below is an example script for setting up a GitLab
                        server:
                    </li>
                    {% verbatim %}
                        <pre>
<code>
packages:
  - curl
  - openssh-server
  - ca-certificates
  - tzdata
  - postfix
  - jq

runcmd:
  - cat /etc/users.txt > /etc/testtesttest
  - |
    FIRST_USER=$(head -n 1 /etc/users.txt | cut -d':' -f1)
    while IFS=':' read -r username password firstname lastname email; do
      if ! id "$username" &>/dev/null; then
        useradd -m -s "/bin/bash" "$username"
        echo "$username:$password" | chpasswd
        if [ "$username" = "$FIRST_USER" ]; then
          usermod -aG sudo "$username"
        fi
      fi
    done < /etc/users.txt

  # Install GitLab
  - apt-get update
  - DEBIAN_FRONTEND=noninteractive apt-get install -y curl openssh-server ca-certificates tzdata postfix jq
  - curl -fsSL https://packages.gitlab.com/install/repositories/gitlab/gitlab-ce/script.deb.sh | bash
  - apt-get install -y gitlab-ce
  - gitlab-ctl reconfigure
  - gitlab-ctl restart

  # Wait until GitLab starts
  - sleep 60

  # Generate Root-Token for API
  - |
    export GITLAB_ROOT_TOKEN=$(openssl rand -hex 20)
    gitlab-rails runner "token = User.find_by(username: 'root').personal_access_tokens.create(scopes: ['api'], name: 'root-token', expires_at: 1.year.from_now); token.set_token('$GITLAB_ROOT_TOKEN'); token.save!"
    echo "$GITLAB_ROOT_TOKEN" > /root/gitlab_token.txt

  # Create user in GitLab
  - |
    export GITLAB_ROOT_TOKEN=$(cat /root/gitlab_token.txt)
    while IFS=':' read -r username password firstname lastname email; do
    response=$(curl --silent --header "PRIVATE-TOKEN: $GITLAB_ROOT_TOKEN" "http://localhost/api/v4/users?username=$username")
    user_exists=$(echo "$response" | jq -r 'if . == [] then 0 else 1 end')

    if [ "$user_exists" -eq 0 ]; then
      curl --request POST --header "PRIVATE-TOKEN: $GITLAB_ROOT_TOKEN" \
        --data "username=$username&name=$firstname $lastname&email=$email&password=$password&skip_confirmation=true" \
        "http://localhost/api/v4/users"
    fi
    done < /etc/users.txt

final_message: "GitLab installation and user creation completed."
</code>
</pre>
                    {% endverbatim %}
                    <li>Step 4: Click the "Save" button and the "Create" button to create the AppTemplate.
                    </li>
                </ul>
            </li>
        </ol>

        <h3>2. Launch an Instance</h3>
        <p>To launch an instance using the created AppTemplate, follow these steps:</p>
        <ol>
            <li>Navigate to the AppTemplates section in the EduVMStore Dashboard.</li>
            <li>Click the "Launch" button next to the GitLab AppTemplate.</li>
            <li>Step 3: [Placeholder for specific step, e.g., "Provide the student access data (e.g.,
                usernames and passwords)."]
            </li>
            <li>Step 4: [Placeholder for specific step, e.g., "Start the deployment."]</li>
        </ol>
    </div>

    <button class="accordion">Example 2</button>
    <div class="panel">
        <p>Example 2</p>
    </div>

    <button class="accordion">Example 3</button>
    <div class="panel">
        <p>Example 3</p>
    </div>
    <hr>


    <script>

        var acc = document.getElementsByClassName("accordion");
        for (var i = 0; i < acc.length; i++) {
            acc[i].addEventListener("click", function () {
                this.classList.toggle("active");
                var panel = this.nextElementSibling;
                if (panel.style.display === "block") {
                    panel.style.display = "none";
                } else {
                    panel.style.display = "block";
                }
            });
        }

    </script>

{% endblock %}