{% extends 'base.html' %}
{% load static %}
{% block title %}Create Instances{% endblock %}

{% block page_header %}
<div style="display: flex; align-items: center; margin-bottom: 20px; justify-content: space-between; border-bottom: 1px solid #e0e0e0;">
    <div style="margin-right: 15px;">
        <h1 class="page-title mb-0">Create Instance</h1>
        {% if image_id %}
        <h4>ID: {{ image_id }}</h4>
        {% endif %}
    </div>
    <div>
        <img src="{% static 'images/Unbenannt.png' %}" alt="Logo" class="logo-img" style="height: 95px;">
    </div>
</div>
{% endblock %}

{% block main %}

<form method="post" action="{% url 'horizon:eduvmstore_dashboard:eduvmstore:instances' app_template_id  %}">
    {% csrf_token %}

    <div class="form-group">
        <label for="app_template_id">{{ _("App Template ID") }}</label>
        <input type="text" class="form-control" id="app_template_id" name="app_template_id" value="{{ app_template_id }}" readonly>
    </div>

    <div class="form-group">
        <label for="flavor_id">{{ _("Select Flavor") }}</label>
        <select class="form-control" id="flavor_id" name="flavor_id" required>
            <option value="" disabled selected>{{ _("Choose a flavor") }}</option>
            {% for flavor_id, flavor_name in flavors.items %}
            <option value="{{ flavor_id }}">{{ flavor_name }}</option>
            {% endfor %}
        </select>
    </div>

    <div class="form-group">
        <label for="instance_name">{{ _("Instance Name") }}</label>
        <input type="text" class="form-control" id="instance_name" name="instance_name" placeholder="{{ _('Enter instance name') }}" required>
    </div>

    <!-- Network Selection -->
    <div class="form-group">
        <label for="network_id">{{ _("Select Network") }}</label>
        <select class="form-control" id="network_id" name="network_id" required>
            <option value="" disabled selected>{{ _("Choose a network") }}</option>
            {% for network_id, network_name in networks.items %}
            <option value="{{ network_id }}">{{ network_name }}</option>
            {% endfor %}
        </select>
    </div>

    <!-- "No Additional Users" Checkbox -->
    <div class="form-group form-check">
        <input type="checkbox" class="form-check-input" id="no_additional_users" name="no_additional_users" checked>
        <label class="form-check-label" for="no_additional_users">{{ _("No additional users") }}</label>
    </div>

    <!-- Dynamic Account Fields -->
    <div id="accounts_section" style="display: none;">
        <h4>{{ _("Accounts") }}</h4>
        <div id="dynamic_account_fields">
            <!-- Fields will be dynamically added here -->
        </div>
        <button type="button" id="add_account" class="btn btn-secondary">{{ _("Add Account") }}</button>
    </div>

    <div style="margin-top: 20px; margin-bottom: 20px;">
        <button type="submit" style="margin-right: 20px;" class="btn btn-primary">{{ _("Launch Instance") }}</button>
        <a href="{% url 'horizon:eduvmstore_dashboard:eduvmstore:details' app_template_id %}" class="btn btn-primary">{{ _("Cancel") }}</a>
    </div>

</form>

<!-- Modal for Success or Failure -->
<div class="modal fade" id="responseModal" tabindex="-1" role="dialog" aria-labelledby="responseModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="responseModalLabel">{{ _("Instance Creation Status") }}</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p>{{ modal_message }}</p>
            </div>
            <div class="modal-footer">
                {% if modal_message == "Instance created successfully." %}
                <a href="/dashboard/project/instances/" class="btn btn-primary">{{ _("Show Instance") }}</a>
                {% endif %}
                <button type="button" class="btn btn-secondary" data-dismiss="modal">{{ _("Close") }}</button>
            </div>
        </div>
    </div>
</div>

<script>
    let accountCount = 1;
    const expectedFields = {{ expected_account_fields|safe }}; // Getting fields dynamically

    document.getElementById("add_account").addEventListener("click", function () {
        const accountSection = document.getElementById("dynamic_account_fields");
        const newAccountDiv = document.createElement("div");
        newAccountDiv.classList.add("form-row");

        let fieldsHTML = "";
        expectedFields.forEach(field => {
            fieldsHTML += `
                <div class="form-group col-md-6">
                    <label for="${field}_${accountCount}">${field.charAt(0).toUpperCase() + field.slice(1)}</label>
                    <input type="text" class="form-control" id="${field}_${accountCount}" name="${field}[]" placeholder="Enter ${field}">
                </div>
            `;
        });

        newAccountDiv.innerHTML = fieldsHTML;
        accountSection.appendChild(newAccountDiv);
        accountCount++;
    });

    document.getElementById("no_additional_users").addEventListener("change", function () {
        let accountsSection = document.getElementById("accounts_section");
        if (this.checked) {
            accountsSection.style.display = "none";
            document.getElementById("dynamic_account_fields").innerHTML = ""; // Clear inputs when disabled
            accountCount = 0;
        } else {
            accountsSection.style.display = "block";
        }
    });

    document.addEventListener("DOMContentLoaded", function () {
        document.getElementById("accounts_section").style.display = document.getElementById("no_additional_users").checked ? "none" : "block";
    });

    {% if modal_message %}
    $(document).ready(function () {
        $('#responseModal').modal('show');
    });
    {% endif %}
</script>
{% endblock %}
